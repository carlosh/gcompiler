<% import
%>
%class prueba

<% parse_code
%>



   
terminal           SEMI, PLUS, MINUS, TIMES, DIVIDE, LPAREN, RPAREN, EQUAL,COMMA;
terminal           FUNCTION,BEGIN,END,RETURN;
terminal   NUMBER, ID;
   
nonterminal String     expr_list, expr_part,id_list,e_l,decl_function,decl_function_l,inicio;
nonterminal CodigoGenerado    expr, factor, term;
   

  inicio -> decl_function_l:lf expr_list:e
  				{
  					
  					String codigo = lf + "\n" +
  									"start:  \n\n\n\n" + e;
  									
  									
  					$ = codigo; 
  				
  				
  				};


   decl_function_l -> decl_function:f decl_function_l:lf
   					{
   						String codigo = lf + "\n" +
   										f + "\n" ;
   										
   										
   						$ = codigo;
   					
   					
   					}
                   |
                   {
                   	$ = "\n";
                   };

   decl_function -> FUNCTION ID:id LPAREN id_list:idlist RPAREN BEGIN expr_list:e END
   					{
   						
   						String codigo = id + ":\n" +
   										"push ebp\n" +
   										"mov ebp, esp\n" +
   										"sub esp, 4\n" +
   										"mov dword[ebp-4],0 ;contador para parametros \n" +
   										idlist + 
   										e + "\n";	
   									
	
						$ = codigo;
   					
   					};
   					

   id_list -> ID:id COMMA id_list:idlist
   				{
   					id = "@" + id;
             		InformacionGeneracion.getInstance().registerVariable(id,"dd","0");
             		
             		String codigo = idlist + "mov edx, dword[ebp-4] ;movemos el contador a edx para ver porque parametro vamos\n" +
             						"mov eax, dword[ebp+8+edx*4]\n" + 
             						"mov dword[" + id + "], eax\n" +
             						"inc dword[ebp-4] ;lo incremementamos para el siguiente parametro \n";
             		
             		$ = codigo;
   					
   				
   				}
             |ID:id
             {
             	id = "@" + id;
             	InformacionGeneracion.getInstance().registerVariable(id,"dd","0");
             	
             	String codigo = "inc dword[ebp-4]\n" +
             					"mov eax, dword[ebp+8]\n" +
             					"mov [" + id + "], eax\n";
             	
             	
             	$ = codigo;
             
             };

  e_l -> expr:e COMMA e_l:el
  		{
  			String codigo = el + e.getCodigo() + 
         					"push " + e.getLugar() + "\n" +
         					"inc ebx\n";	
         					
         					
         	$ = codigo;	
  			
  		}
         |expr:e
         {
         	
         	String codigo = e.getCodigo() + 
         					"push " + e.getLugar() + "\n" +
         					"mov ebx, 1\n";
         	
         
         	$ = codigo;
         };

   expr_list -> expr_list:el expr_part:ep
                 { $ = el+ep;}
                 |
                 expr_part:ep
                 { $ = ep;}
                 ;
   



   expr_part -> expr:e
                 {
                 
                 
                 	InformacionGeneracion.getInstance().registerVariable("msg","db","'%d',10,13,0");
                 	
                 	
                    $ = e.getCodigo()+
                                    "push "+e.getLugar()+
                                    "\npush msg\ncall [printf]\nadd esp,8\n";
                 }
                 SEMI
                 | ID:id EQUAL expr:e SEMI
                 {
                     id = "@" + id;
                     InformacionGeneracion.getInstance().registerVariable(id,"dd","0");

                     $ = e.getCodigo() +
                              "mov eax,"+e.getLugar()+"\n"+
                              "mov ["+id+"],eax\n";
                 }
                 | RETURN expr:e SEMI
                 {
                 	String codigo = e.getCodigo() + 
                 					"mov eax, " + e.getLugar() + ";guardamos el valor de retorno \n" +
                 					"mov esp, ebp\n" +
									"pop ebp\n" +
									"ret";
									
					$ = codigo;
                 
                 }
                 ;
  
   expr      -> expr:e PLUS factor:f
                   {
                      String lugar = InformacionGeneracion.getInstance().generarEtiqueta("@T");
                      InformacionGeneracion.getInstance().registerVariable(lugar,"dd","0");
                      lugar="["+lugar+"]";
                      String codigo = e.getCodigo()+f.getCodigo()+
                                      "mov eax,"+e.getLugar()+"\n"+
                                      "add eax,"+f.getLugar()+"\n"+
                                      "mov "+lugar+",eax\n";
                      $  = new CodigoGenerado(codigo,lugar);
                   }
                 |
                 expr:e MINUS factor:f
                   {
                      String lugar = InformacionGeneracion.getInstance().generarEtiqueta("@T");
                      InformacionGeneracion.getInstance().registerVariable(lugar,"dd","0");
                      lugar="["+lugar+"]";
                      String codigo = e.getCodigo()+f.getCodigo()+
                                      "mov eax,"+e.getLugar()+"\n"+
                                      "sub eax,"+f.getLugar()+"\n"+
                                      "mov "+lugar+",eax\n";
                      $  = new CodigoGenerado(codigo,lugar);
                   }
                 |
                 factor:f
                   { $=f; }
                 ;
   
   
   factor    -> factor:f TIMES term:t
                   {
                      String lugar = InformacionGeneracion.getInstance().generarEtiqueta("@T");
                      InformacionGeneracion.getInstance().registerVariable(lugar,"dd","0");
                      lugar="["+lugar+"]";
                      String codigo = f.getCodigo()+t.getCodigo()+
                                      "mov eax,"+f.getLugar()+"\n"+
                                      "imul eax,"+t.getLugar()+"\n"+
                                      "mov "+lugar+",eax\n";
                      $  = new CodigoGenerado(codigo,lugar);
                   }
                 |
                 factor:f DIVIDE term:t
                 {
                 	String lugar = InformacionGeneracion.getInstance().generarEtiqueta("@T");
                 	InformacionGeneracion.getInstance().registerVariable(lugar, "dd", "0");
                 	lugar="["+lugar+"]";
                 	String codigo = f.getCodigo() + t.getCodigo() + 
                 					"mov eax," + f.getLugar() + "\n" +
                 					"mov edx, 0\n" +
                 					"mov ebx, " + t.getLugar() + "\n" +
                 					"idiv ebx\n" +
                 					"mov " + lugar + ", eax \n";
                 					
                 	$ = new CodigoGenerado(codigo,lugar);
                 }
                 |
                 term:t
                  { $ =t; }
                 ;
      
   term      -> LPAREN expr:e RPAREN
                 { $ = e; }
                 |
                 NUMBER:n
                 { $ = new CodigoGenerado("",n); }
                 |
                 ID:i
                 { $ = new CodigoGenerado("","[@"+i+"]"); }
                 | ID:id LPAREN e_l:el RPAREN
                 {
                 
                 	String lugar = InformacionGeneracion.getInstance().generarEtiqueta("@T");
                 	InformacionGeneracion.getInstance().registerVariable(lugar, "dd", "0");
                 	lugar="["+lugar+"]";
                 	
                 	String lugarEsp = InformacionGeneracion.getInstance().generarEtiqueta("@T");
                 	InformacionGeneracion.getInstance().registerVariable(lugarEsp, "dd", "0");
                 	lugarEsp="["+lugarEsp+"]";
                 	
                 	
                 	String codigo = el + 
                 				"imul ebx, 4 \n" +
                 				"mov " + lugarEsp + ", ebx\n" +
                 				"call " + id + "\n" +
                 				"add esp, " + lugarEsp + "\n" +
                 				"mov " + lugar + ", eax \n"; 
                 	
                 	
                 	$ = new CodigoGenerado(codigo, lugar);
                 
                 }
                 ;
